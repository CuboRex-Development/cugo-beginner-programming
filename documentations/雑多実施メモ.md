# MTG関連
- 実施日： 毎週月曜日（実施不可の場合は水曜日）
- リンク： https://meet.google.com/wgp-owqc-sva

# 現行タスク（暫定記載）
## タスク一覧（10月対応予定分）：チェックしたら完了

<details>
<summary>詳細</summary>

### ソフトバグ関連
- [ ] モード切替時にびくつく
  - [x] 平尾対処
  - [ ] 中村さん確認
- [ ] モード切替中にびくびくを続ける
  - [x] 平尾対処
  - [ ] 中村さん確認
- [ ] 4m以上進む指示を出すと止まらなくなる
  - [x] 平尾対処
  - [ ] 中村さん確認
### ハード故障関連
- [x] ヒューズ切れ
  - [x] 平尾対処
  - [x] 中村さん確認
- [ ] 右モータ故障
  - [ ] 平尾対処
    - [ ] 原因確認：以下候補
      - [x] モータ故障
      - [x] ESC故障
      - [x] ESC→RC8への過電流供給:これが原因ぽい
      - [x] Arduinoシールド故障
  - [ ] 中村さん確認  
### 機能追加関連
- [ ] 位置制御関連の実装
  - [ ] 平尾対処
    - [x] 速度制御の上に位置制御をかぶせる：意識合わせ済み  
    - [x] 目標位置偏差からPID制御ロジックの実装
    - [x] 速度上限の180rpm異常の速度入力させない実装
    - [x] susumu コマンドの追加（距離,目標速度上限）の追加　指定しない場合は90
    - [x] susumu以外 コマンドの追加（距離,目標速度上限）の追加　指定しない場合は90
    - [x] 制御停止条件：意識合わせ済み
    - [ ] パラメータフィッティング
  - [ ] 中村さん確認
- [ ] リファクタリング（優先度：低）
  - [ ] 平尾対処
    - [x] 400行退避
    - [ ] 全退避 
  - [ ] 中村さん確認

</details>

## タスク一覧（11月対応以降予定分）

<details>
<summary>詳細</summary>

- [ ] 制御ロジックの更新
  - [ ] ２輪制御への対応
  - [ ] 任意のルート、速度への追従制御
  - [ ] 位置偏差から直接サーボ入力の制御ロジックの実装
  - [ ] 速度上限制御の要件に合わせた具体化
    - [ ] 2自由度制御の実装：FFとFBの組み合わせ
  - [ ] 制御停止条件の精緻化（ある程度落ち着いたら停止等）
  - [ ] 車体回転の制御を任意の度数に対応
  - [ ] より精緻なパラメータフィッティング
- [ ] motorconntorllerの更新
  - [ ] 位置偏差制御ロジック対応
  - [ ] リファクタリング
  - [ ] エンコーダーカウントを初期化させずにモードチェンジができるようにしたい
- [ ] リファクタリング
  - [ ] 単純に見た目の整理
- [ ] ECS→RC8への供給電源過多への対処
- [ ] お客様に見せる用のコメントの出し方に変更


</details>

# 進捗メモ
## 2022/12/06：MTG
- シリアルコメントの整形
  - 実装済みだが一部相談
    - 開始する際のｍおよび度数をカウント数から逆算すると元の値ではなくなる
      - 選択肢①：このまま　初期宣言と見た目のずれあり
      - 選択肢②：arduino_flag_cmd_matrixの格納メモリ追加：コマンドサイズに影響　
        - mと度数の表現にfloatを利用すれば4バイト追加に1コマンドあたり16→20バイト消費　25%コマンド消費UP　60 コマンドなら48コマンドおちる
      - ★選択肢③：開始だけ消す
        - ###01番目のコマンド：開始　前進 ###
        - ###01番目のコマンド：終了　1.0234m 進んだ ###
        - 一旦これでFIX
- クイックスタート：見せ方の確認
-  次回MTG 12/12 13:00~13:30 
-  次タスク
   -  クイックスタートのこりちょびっとやりきる
   -  中級編
      -  アプリ層：お客様が作るところ
      -  PID制御、モードの制御の切替　割り込みにできるのか？　LCDとかセンサ読みたい
      -  目標：中級者用コードは一月末に出したい
         -  仕様
            -  プロポ切り替えがどのタイミングでも確実に作動する（delayは別）
            -  loop内に
               -  例LR 90RPM指定してwhile抜けたら停止LとRをそれぞれ90rpmで指定できるとめたいときは0で止められる
               -  L_verocity R_verocity（速度指定の関数）の指定　現在の速度確認
                  -  motorcontorollerの更新で検討　金曜19:00に再度連絡
               -  susumu()あったらいいくらい？
## 2022/11/28：MTG
- 進捗
  - シリアルコメントの整形
    - ★開始の後に何を開始したか書く　ｍできない　待つ（あれば）
      - 終了の際に結果を載せる　ｍ進んだ、回転　待つ(あれば)
      - 例
        - ###01番目のコマンド：開始　1.0m 進む ###
        - ###01番目のコマンド：終了　1.0234m 進んだ ###
  - MEGA対応断念
    - 空きかつ、利用可能な共通のPCITRがD０しかなかったため
    - ★一旦はUNOで動くのでまずは出すこと優先で
      - 組み込みはMEGAだけではない（あくまでone of them）
      - 必要になれば、ESP32も見据えていく（あくまで検討まで）
  - ドキュメント作成
    - 言い回しや構成で迷子になり、途中。完成まで1割くらい？
    - - そもそも誰向け？
  - 初学者
- 人の技術レベルは？
  - Aruduino知らない
  - パソコンはギリギリ知っている
  - エクセル触れる？：とはいえIDEインストーラ軽めにつくる
- 対象年齢：言い回し　あくまで説明書
  - 下限　中学生以上　高校生　：イマドキはスクラッチやってる
  - メインターゲット：事務仕事しているがプログラミングはほとんどやってない　２０代後半～４０代くらいの企業勤務or若手の農家（むしろハイテクの人も多い）
- どこでやるよう？学習編の内容は？
  - あくまで使い方説明
  - TIPS程度で良い:教育、講習
  - とりあえず書きまくる、書きなぐりでもいいので
  - 消すのはあとでもいいので役に立ちそうななのは全部載せる
- どれくらいの時間でやる？
  - 買った人向け　あくまで一回無事動くまでが必達★
    - コマンドリストは充実させておく
  - そっから発展性はあくまで案内程度
- 本書を読めば何ができる？：↑
- メンテは？あくまでread meになる
  - わからん！まずは動くものでいこう
  - 困りごとがあればイシュー立ててもらう
  - 多いイシューがFAQに載せる

## 2022/11/23：作業
- シリアルのコメント整形完了
- MEGA対応の課題発覚
  - コントローラように利用していた、D5D6D7はMEGAでは割り込み対応していない模様
  - 詳細：https://cuborex.slack.com/archives/C03U9PNR09E/p1669160902224469?thread_ts=1669115104.224669&cid=C03U9PNR09E
## 2022/11/22：MTG

- MEGA対応
  - MEGAの割り込み用のPCINTがみつからず苦戦中
  - コマンドは400くらいまで可能
  - ＠engineer
  - Arduino　MEGA2560で
  -   PCMSK2 |= B11100000;  // D5,6,7を有効
  -   PCICR  |= B00000100;  // PCIE2を有効
- 見せ方の整形
  - 一旦作成済みのため見せて相談。
  - N番目の実行開始、実行終了を見れるように
  - CUGOのロゴ載せちゃう　ASCIIアート
  - 終了の後のコマンド読み込みはいらない　即RCモードへ移行で良い
  - ★コード内のコメントも凍結する最後に不要なものは消す（独り言は消す、説明残す）
- 説明書の作成：目次レベルと具体にならない
  - 前提条件：ハードが組み終わっていること
  - 写真と日本語
  - ご挨拶
  - CugoAruduinoの作り方
  - ZIPダウンロードから
  - AruduinoIDEを入れる
  - コマンド説明
  - コマンド入力例
  - １ｍぐるっと回る例：正方形の書き方
  - 課題　正三角形：精度怪しいかも笑？？
  - 直進コマンド、まえるの gifあにめ
## 2022/11/17：MTG

- グローバル変数減らす対応
  - 課題整理
    - 現状
      - 命令数が上限20までCMD_SIZE 20
        - RAM使用　1658バイト（80%）
    - 目標
      - CMD_SIZEを気にせずとも使えるくらいたくさんの命令がしたい
        - CMD_SIZE 1あたり24バイト使用　100使用なら2400バイトのためハード的に不可
        - 一旦現状の2倍の40を利用できるようにする？
    - GAP：やること
      - ①メモリ確保
      - ②そもそもarduino_cmd_matrixのつくりを変えるべきでは？waitでも24バイト確保しているのは無題 　
  - 手段検討①
    - × :boolをcharやバイナリに変更　１バイト確保から１ビット確保へ
      - 予想される効果：14バイト　（16バイトから2バイトへ）
        - boolの数16個　仕様メモリ16バイト
      - 手間：2営業日コース
        - 書き換えが多く影響範囲が大きい
    - ○ :F()マクロの利用
      - 効果：78バイト以上(約3%) 1658→1580
      - 効果が見られたので、全printに実施
        - コマンド上限数以上にコマンドを設定しています。意図しない走行をさせないため強制終了。→これは稼げた
        - printをFrashメモリに格納
      - 参考：https://qiita.com/ma2shita/items/89ed5b74698d4922efdd
  - 参考実験
    - print内の文字はグローバル変数を2文字単位で2バイト確保している（実験にて確認）
    - boolは１バイト確保している　(intは2バイト)
      - 参考元：https://www.arduino.cc/reference/en/language/variables/data-types/bool/ 
 - 手段検討②
   - arduino_cmd_matrixの分割
     - 現在フラグも含めてlong intを使用
       - arduino_cmd_matrixの中身
         - 0:目標カウント数左 1:目標カウント数右 
         - 2:待機時間 3:ボタン押す押さないフラグ 
         - 4:上限速度左 5:上限速度右
     - 分割案　1cmdあたり24バイトから16バイトへ
       - 0,1とそれ以外の分離
         - 0,1 はlong intが適切 計8バイト
         - 2はunsigned intが適切   ★long必要？ 計2バイト
         - 3はboolで良いのでは？計2バイト ★1バイトにもできる
         - 4,5はintが適切　計4バイト
           - long int arduino_count_cmd_matrix[CMD_SIZE][2];
           - int arduino_flag_cmd_matrix[CMD_SIZE][4];
   - waitやボタンコマンド時のメモリの節約　waitや待つでれば、1コマンド当たり12バイト節約可能
     - そもそものcmd_matrix周りのロジック変更が必要なため個数大
  - 実施現状
    - CMD_SIZE 20から60~70までは実現可能
    - ArduinoUNOやる上では一旦これでも十分かと（一旦これでFIX）
      - これ以上やる場合
        -  効果大？：waitやボタンコマンド時のメモリの節約
        -  効果小？：boolをcharやバイナリに変更
- 真っ直ぐ進ませたい
  - 机上検討まで：ノイズ処理どうする？パラメータはロバスト性は？ 
- 備考：お得意様というか付き合いのある人向け（イノベーター向け）には12月から入れる予定
  - 一旦出せるところまであと少し担ってきた感じかと
- 今後の動き：ローンチに向けて：優先順位もこの順
  - Arduino MEGA購入
    - https://www.amazon.co.jp/keyestudio-Mega-2560-%E3%83%9C%E3%83%BC%E3%83%89%E3%81%A7%E4%BA%92%E6%8F%9BArduino-USB%E3%82%B1%E3%83%BC%E3%83%96%E3%83%AB/dp/B01COV7KRS/ref=asc_df_B01COV7KRS/?tag=jpgo-22&linkCode=df0&hvadid=546843474638&hvpos=&hvnetw=g&hvrand=9420013226856642307&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=1009333&hvtargid=pla-1434698976945&psc=1
  - Arduino MEGAでの実装テスト、確認（★11月中必達）
    - PINの宣言とかで差分あるかも？
    - 一旦まとめればそのままコードにするが無理なら分ける 
  - print分の表現追記修正（一旦叩きを平尾で作る）
    - お客様向けコメントを追記修正方針
      - 自分が売ったコマンドがなんであるかのコマンドを記載
      - ループ中の文は基本載せない（見ても流れてしまうので）
      - 最初と最後が見やすく
      - コピーライトとか：アパッチ2.0にならう cuborex.inc
  - ドキュメント関連
    - 追って必要であれば記載：一旦ペンディング
  - ちゃんと前に進む
    - 程度は一旦できる範囲で（急ぎではない）
  - リファクタリング　
    - 随時
    - 割り込みにもっと入れてみてバグ、競合確認したい
    - waitを使わせない
- ローンチ後について：優先順位もこの順
  - if,switchとか使えるような中級者向け用のプログラミング
    - API的に？
  - 正確な制御（オドメトリえ進んで目標位置まで進む）
    - 行き過ぎなら戻す　
    - xyΘを指定して進む
  - ライントレース機能追加
    - 光センサでライントレース
    - シールド変更要否確認：4pinくらいで見る
    - 止まる、待つ、曲がる、ライントレースを並列にしたい。ラインが開始、終了するまではしる 
## 2022/11/07：MTG
<details>
<summary>詳細</summary>

- コードレビューMTG　11/2　まとめておく
  - 不要なネスト周りはリファクタリングが必要
    - 参照渡しと引数としていれているものが混在していてポリシーを共通化する必要がある。
    - ★メモリ不足が深刻
      - フラグ周りはboolがintで格納されているため１６ビット確保されているここら辺が無駄　選択肢
        - char型でいれる？　構造体化　バイナリでもつ？
  - L_MAX_COUNT_I　の積分補償の上限は摩擦が大きいときに大きめに設定しないといけない。旋回時の摩擦が大きい。ここは代わりに作らないといけない。
    - 他：Pゲインを大きくする
    - ２自由度制御？　積分補償が必要
    - ★//モーターの速度上限の２重でやっている可能性あり
      - motorcontrollerの中身を見て不要なら消す
    - 速度についての指示を上限ではなく、目標速度にするなら２自由度制御？
  - 変数周りを構造体化
- 今週稼働分はレビューのみのため、今週または来週にシフト予定
  - 稼働の割き方は要相談
- 利用レベル
  - れべる１：excuteだけいじるまたはライントレースのみ
  - れべる２：コードをいじって自由にいじる
    - PIDパラメータがいじれる、エンコーダーの値をよめる　制御の勉強に使えるような
      - 仕組みが分からずともどこまで動かすか組み込める状態 
    - 条件制御を自分でいじれる
  - れべる３：ROS
    - 仮想ラインに追従させたい　参考：https://t-frog.com/ 
- 改善点の相談と実施　優先順位決め
- ★課題今週やること
  - 真っ直ぐ進ませたい
    - 制御が残りのカウント数をもとにFBが入るために以前より左右に振れやすい FFならあまり出なかった。 
    - 左右の制御を同期させる必要がある：２輪の自己位置を計算して進める
  - コマンド数を増やしたい　今は20　
    - グローバル変数のメモリ減らしたい
      - 距離や速度の変数をメモリ減らせるように量子化（上限２５ｍとか）
      - boolフラグの整理 

</details>

## 2022/10/ 31：MTG
<details>
<summary>詳細</summary>

- コードレビューMTG　11/2　まとめておく
  - 直した箇所をissueに建てる
  - 別途時間をとってレビュー
    - 変更箇所の意識合わせ
- デバッグ結果の意識合わせ
  - 距離ずれについて：詳細は追って試験予定
    - 原因の意識合わせ（手前に止まった）
      - ◎カウンタ？：分解能以下の積算では
      - 制御？
      - 停止ロジック？
    - 対策検討
      - 量子化制御
      - センサ増やす
- このサービスの用途誰向け？
    - ArduinoKit：単純作業のルーチン化
      - ロボットDXは簡単だよってことを伝えたい
      - とはいえ導入期
        - 売り先：企業の教育系人事、土建のDX（デモ）
        - 売り方：農家の出荷場 
          - 簡易AGVとしてライントレースしてくれるだけでいい
          - 理想：ナビつき作ってわかるはじめてのプログラミング
        - 現場の自動化を楽しんでもらう
        - ガチのレゴを作ろう
    - ４P分析的な
      -  競合：いなほさん、サウザー? とはいえ不整地分野としては別
  - 誰向けと使われ方ごとに機能洗い出し
    - 1. 学校、企業の教育利用
    - 2. 不整地での現場利用
      - ライントレース
- ネクストアクション
  - コードレビューとそれに合わせた修正→今週はここがメイン
    - ブラッシュアップと改善点を上げる作業でも良い
  - 教育利用用の試験とパッケージ化
    - ドキュメント整理
    - 見せ方全般：チラシ、取扱説明書、
  - アップグレード：ライントレース

</details>

## 2022/10/ 30：作業
<details>
<summary>詳細</summary>

- リファクタリング 1330→548
  - 制御周りや停止についてはまだ触る可能性あるため退避せず。それ以外の退避できそうなのは退避。
  - このサービスの用途誰向け？とかが知りたい。いまだにイメージがフワフワしている。教育目的だけ？５ＷＩＨ的に知りたい。
    - 一度どこかでの利用用途に参加した方がイメージわきやすいかも
    - FIXに向けてのコメントの見せ方　見せっぷりを確認したい。（print コード内のコメント）
</details>

## 2022/10/27：作業
<details>
<summary>詳細</summary>

- susumu以外に速度上限コマンドの追加修正完了
</details>

## 2022/10/26：作業
<details>
<summary>詳細</summary>

- バグの確認
  - arduino_cmd_matrixをlong intで定義して解決
    - グローバル変数８４％になり動作不安定に
    - コメント減らしてなんとか８１％に要相談
- 機能追加
  - 速度上限180rpmを超えないように追加
- ユーザの任意の速度上限ってほんとにいるの？回転角度すら45度刻みなんだけども、一旦susumuだけ導入する？ 
- 目標速度上限の追加　指定しない場合は90 susumuは実装済みそれ以外はばぐあり？要確認
- コメント複製:2点報告です。
  - ①４ｍ以上進むと進み続けるバグ
    - 対処方法としてarduino_cmd_matrix　をlong intで定義することで解決しました。ただし、メモリがさらに圧迫されている状況です。※現行ではグローバル変数で８１％消費中一旦バグとしては対処完了しましたのでご報告です。
  - ②起動中右モータが動かなくなる事象について
    - デバッグ以外の時間もバッテリオンにしていたために起こっていた事象のようです。本日はデバッグ以外の時間はこまめにon/offしていますが一度右モータの故障は再現していません。やはり、RC8への電流消費が原因のようです。こちらは経過報告になります。
- 今日はここまで 

</details>

## 2022/10/25：作業
<details>
<summary>詳細</summary>

- mdの整理整頓
- ４ｍ超えた際のバグ確認
  - 値を確認
</details>

## 2022/10/22：作業兼24MTG
<details>
<summary>詳細</summary>

- ハード不具合確認：解決済
  - 新バッテリー交換のみでは動作せず（充電後再トライ失敗）
  - 電源スイッチは動作不良なし、オン通電、オフ絶縁
  - 左モーター動かず：モーター単体とエンコーダーも個別に動くこと確認済み
    - ただの接触不良
  - 原因：ヒューズ切れと左モーターケーブル接触不良
  - 左モーター動作不良
    - 同じ条件でもついたりつかなかったりしたので、接触不良？
- バグFIX
  - 切り替え中に暴れる：FIX済
    - 各種初期化をモードが最初に切り替わったときに変更RC→ARDUINO
    - ★仕様通り モードを切替した最初の瞬間にモードチェンジ
  - 切り替え瞬間に暴れる：FIX済
    - calcRpmのLPFが原因
      - エンコーダー値を初期化で対応　motorcontrollerの一部変更これでよい？エンコーダー初期化しない対応するにしても、motorcontroller側でのコード変更は必須（モード切替時のエンコーダー値の退避の対応）
      - motorcontrollerはエンコーダー初期化しているためROS等との整合性確認：確認
      - ★motorcontroller含めて将来対応
  - エンコーダーの値が振り切れる件：要確認
    - 事象再現ならず、対処は入れているのでMTGにて試験したい
    - これは４ｍ以上で再度チャレンジ
- 位置制御
  - 一応動いた：片輪のみ
- 残タスク
    - エンコーダーの値が振り切れる件
      - 急ぎ対応
    - 追加：速度上限設定
      - susumu関連すべてを変数の個数で２つ関数に　プロトタイプ宣言　速度上限設定
    - 右モータ故障？相談
      - arduino シールド：直つなぎラジコン化
      - RC8 レギュレータの影響？
      - ESCの交換 24mm か養生
      - 一旦動かして進める
    - パラメータフィッティング
      - 一旦はPDゲインで重たいものでも運べるようにPは大目に
    - リファクタリング：どこまで
      - やれる範囲で継続
    -  済：停止条件の相談＆実装
      - エンコーダーカウントストップで対応
      - 将来的には範囲内に〇ｍｓ間いればストップ
  
</details>

## 2022/10/17:MTG
<details>
<summary>詳細</summary>

- PIDの簡易版について、速度のPIDの係数は定数扱いとして、位置制御のPIDのパラメータフィッティングをやるで良い。位置の動きとしては電車ぐらいのイメージ
- 本格的な制御①とかはあとでやる。まずは動くもの
- 目標達成チェックはそのまま？→変更してよい：範囲で決めておく。（abs 600カウント数）
- 回転は現状４５度刻み周りで良い。〇将来的には度数で制御
- 今週タスク
  - 故障対応明日届き次第
  - PIDパラメータフィッティング：今週
  - バグFIX：今週
    - set_arduino_cmd_matrixのcmd_nをlong intにしたい、〇将来：UNOの場合は4バイト　MEGAは2バイトで切り替えたい。
    - 切り替え中の挙動見直し
  - リファクタリング
- 引っ越しは１１月後半頃？
</details>

## 2022/10/16
<details>
<summary>詳細</summary>

- リファクタリング　1330→866
- 本体の故障発生：https://cuborex.slack.com/archives/C03U9PNR09E/p1665887750979189
- ★void set_arduino_cmd_matrixこれがうまくいってない気がする。
　→故障回復後に要調査
- vscode導入 gitと連携済
- コード読み取り
　job_10msごとに
　↓check_mode_change()：モード（rc or arduino）識別
　　↓arduinoだったらarduino_mode()へ
　　　↓CMD_EXECUTE();
　　　　↓susumu→go_foward

- 前進の制御ロジック
- エンコーダのカウント数が目標距離を超えるまで速度を一定に制御、一定値を超えるとモーターの速度０を強制入力し修了を左右で実施。
- 疑問：どの制御までやるか？
  どちらかというとシーケンス制御になっている。どうやる？
- ２輪制御をするのか？するなら２輪モデルで制御が必要（今回はスコープ外？）
- 次元数にパラメータフィッティングに不要な変数が２つ増えるだけ全然うれしくない。
- 定数目標値で安定してたPIDの速度制御が可変の入力パラメータがもクフ王になった際の挙動が既存の３つのPIDパラメータフィッティングも必要になる可能性あり　簡易版が逆にいばらの道になりそう、、
- L側目標達成チェックはそのまま？線形制御とかみ合わない。発散せず、すごくきれいなパラメータが見つかれば問題ないが、、
- とはいえ簡易版追記：今日はおわり
</details>

## 2022/10/14
<details>
<summary>詳細</summary>

- メモを載せる：github gitにpushしてみる　cliでやりたい！！
- スケジュール
前半
・リファクタリング
・バグFIX
・PIDの仕組みまで作る→未着手よりかはまず手を付けてほしい　最低限のPDでも良い　
後半
・試験
・パラメータフィッティング
- 11月には５件くらい売る予定
- 目標　+-10cmくらい
- 目標距離→PID→速度の積分値→距離
  PID→モーター→速度
- 発振可能性はあるがまずは手を付ける：
　リファクタリング
　→進捗２００行程度は以降完了：動作も不具合なし
　→どこまでやるか相談　モータのクラス周りは少し触るのが大変
 →go_foward clockwiseは移動させる
 バグ回り：モード切替時のlong long intの数値確認
　　　　（エンコーダのカウント数のチェック）
- 気になる点
Arduinoモード中ではRCモードの支持はリセットしか受け付けないでよいか？
実行後はRCモードに変わる
なにもしなくても定期的にびくっとなる
バッテリの充電途中でぬいてもOK？
</details>

## y/m/d：作業orMTG
<details>
<summary>詳細</summary>
- テンプレ

</details>